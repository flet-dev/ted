name: TedTheBot â€” Draft reply

on:
  issues:
    types: [opened, edited, reopened]
  issue_comment:
    types: [created]

permissions:
  contents: read
  issues: write

jobs:
  draft:
    runs-on: ubuntu-latest

    # Skip PRs (issue_comment fires on PRs too)
    if: >
      (github.event_name != 'issue_comment') ||
      (github.event.issue.pull_request == null)

    steps:
      - uses: actions/checkout@v4

      # Optional: only respond to trusted people (recommended)
      - name: Guard - trusted commenters only
        if: github.event_name == 'issue_comment'
        run: |
          set -euo pipefail
          assoc="${{ github.event.comment.author_association }}"
          case "$assoc" in
            OWNER|MEMBER|COLLABORATOR) exit 0 ;;
            *) echo "Untrusted author_association=$assoc; skipping."; exit 1 ;;
          esac

      # Skip if comment is a command or from a bot
      - name: Guard - skip commands/bots
        if: github.event_name == 'issue_comment'
        run: |
          set -euo pipefail
          actor="${{ github.actor }}"
          body="${{ github.event.comment.body }}"
          if [[ "$actor" == *"[bot]" ]] || [[ "$actor" == "github-actions" ]] || [[ "$actor" == "github-actions[bot]" ]]; then
            echo "Bot actor ($actor); skipping."
            exit 1
          fi
          if [[ "$body" =~ ^/ted[[:space:]] ]]; then
            echo "Ted command; skipping."
            exit 1
          fi
          # Also skip if it's already a Ted draft
          if echo "$body" | grep -q "TedTheBot â€” Proposed reply"; then
            echo "Looks like Ted draft; skipping."
            exit 1
          fi

      - name: Install Codex CLI
        run: |
          set -euo pipefail
          curl -L -o /tmp/codex.tgz \
            https://github.com/openai/codex/releases/latest/download/codex-x86_64-unknown-linux-musl.tar.gz
          tar -xzf /tmp/codex.tgz -C /tmp
          mv /tmp/codex-x86_64-unknown-linux-musl /usr/local/bin/codex
          chmod +x /usr/local/bin/codex
          codex --version

      - name: Create GitHub App token (IAT)
        id: app-token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ secrets.TED_APP_ID }}
          private-key: ${{ secrets.TED_APP_PRIVATE_KEY }}
          # permission-issues: write
          # permission-contents: read

      # Remote MCP config (your experiment: IAT as bearer)
      - name: Configure Codex MCP (remote GitHub MCP)
        run: |
          set -euo pipefail
          mkdir -p ~/.codex
          cat > ~/.codex/config.toml <<'TOML'
          [mcp_servers.github]
          url = "https://api.githubcopilot.com/mcp/"
          bearer_token_env_var = "GITHUB_MCP_BEARER"
          http_headers = { "X-MCP-Toolsets" = "context,issues,repos" }
          startup_timeout_sec = 20
          tool_timeout_sec = 60
          enabled = true
          TOML

      - name: Prepare prompt + schema + event payload
        run: |
          set -euo pipefail
          mkdir -p .ted
          cp "${GITHUB_EVENT_PATH}" .ted/event.json

          cat > .ted/out.schema.json <<'JSON'
          {
            "type": "object",
            "properties": {
              "should_draft": { "type": "boolean" },
              "draft_body": { "type": "string" }
            },
            "required": ["should_draft", "draft_body"],
            "additionalProperties": false
          }
          JSON

          cat > .ted/prompt.txt <<'PROMPT'
          You are TedTheBot (tier-0/tier-1 GitHub support).

          Input: The full GitHub webhook payload is in .ted/event.json.

          Task:
          1) Decide whether to produce a draft reply (should_draft).
             - If issue_comment event: only draft if the new comment is a question/help request.
             - Skip "+1", "thanks", emojis, or non-questions.
          2) If drafting, create a proposed reply (draft_body) that is concise & actionable.
          3) DO NOT post the final answer. Instead, format a "Proposed reply" message that a human will approve.
             The draft comment MUST be clearly labeled and must include:
             - A short header: "### ðŸ¤– TedTheBot â€” Proposed reply (needs approval)"
             - The proposed reply content
             - Instructions: "Reply with /ted approve to post, or /ted regenerate to regenerate."
             - A hidden metadata block:

             <!-- ted:draft {"kind":"draft","version":1} -->

          Rules:
          - Never include secrets.
          - Ask for missing info as a short checklist.
          - Prefer reading issue context via MCP tools if needed before drafting.

          Output must match .ted/out.schema.json.
          PROMPT

      - name: Run Codex (generate draft text only)
        env:
          CODEX_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          GITHUB_MCP_BEARER: ${{ steps.app-token.outputs.token }}
        run: |
          set -euo pipefail
          codex exec --output-schema .ted/out.schema.json -o .ted/out.json "$(cat .ted/prompt.txt)"
          cat .ted/out.json

      # Post the draft via MCP (Codex performs the MCP tool call)
      - name: Post draft via MCP
        env:
          CODEX_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          GITHUB_MCP_BEARER: ${{ steps.app-token.outputs.token }}
        run: |
          set -euo pipefail
          should="$(jq -r '.should_draft' .ted/out.json)"
          body="$(jq -r '.draft_body' .ted/out.json)"
          if [ "$should" != "true" ]; then
            echo "No draft needed."
            exit 0
          fi

          # Ask Codex to post the draft via MCP tool github__add_issue_comment.
          # (We do this in a second call to keep responsibilities clean.)
          cat > .ted/post.schema.json <<'JSON'
          { "type":"object", "properties": { "posted": { "type":"boolean" } }, "required":["posted"], "additionalProperties": false }
          JSON

          cat > .ted/post.prompt.txt <<PROMPT
          Post the following draft comment to the current issue via the GitHub MCP tool "github__add_issue_comment".
          Use owner/repo and issue number from .ted/event.json.
          Comment body (GitHub Markdown):
          ---
          ${body}
          ---
          Output JSON: {"posted": true} only if the tool call succeeded.
          PROMPT

          codex exec --output-schema .ted/post.schema.json -o .ted/post.out.json "$(cat .ted/post.prompt.txt)"
          cat .ted/post.out.json