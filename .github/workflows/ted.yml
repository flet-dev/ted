name: TedTheBot (draft + approval)

on:
  issues:
    types: [opened, edited, reopened]
  issue_comment:
    types: [created]

permissions:
  contents: read
  issues: write

env:
  CODEX_MODEL: gpt-5.2-codex-max

jobs:
  draft:
    runs-on: ubuntu-latest

    # Skip PRs (issue_comment fires on PRs too)
    if: >
      (github.event_name != 'issue_comment') ||
      (github.event.issue.pull_request == null)

    outputs:
      should_post: ${{ steps.readout.outputs.should_post }}
      escalate: ${{ steps.readout.outputs.escalate }}

    steps:
      - uses: actions/checkout@v4

      # Optional: only act on trusted commenters
      - name: Guard - trusted commenters only
        if: github.event_name == 'issue_comment'
        run: |
          set -euo pipefail
          assoc="${{ github.event.comment.author_association }}"
          case "$assoc" in
            OWNER|MEMBER|COLLABORATOR) exit 0 ;;
            *) echo "Untrusted author_association=$assoc; skipping."; exit 0 ;;
          esac

      # IMPORTANT: read comment body safely from $GITHUB_EVENT_PATH (no inline expansion)
      - name: Guard - skip bots and /ted commands (safe)
        if: github.event_name == 'issue_comment'
        run: |
          set -euo pipefail
          actor="${{ github.actor }}"
          body="$(jq -r '.comment.body // ""' "$GITHUB_EVENT_PATH")"

          if [[ "$actor" == *"[bot]" ]] || [[ "$actor" == "github-actions" ]] || [[ "$actor" == "github-actions[bot]" ]]; then
            echo "Bot actor ($actor); skipping."
            exit 0
          fi

      - name: Install Codex CLI
        run: |
          set -euo pipefail
          curl -L -o /tmp/codex.tgz \
            https://github.com/openai/codex/releases/latest/download/codex-x86_64-unknown-linux-musl.tar.gz
          tar -xzf /tmp/codex.tgz -C /tmp
          mv /tmp/codex-x86_64-unknown-linux-musl /usr/local/bin/codex
          chmod +x /usr/local/bin/codex
          codex --version

      # IAT for MCP reads during drafting
      - name: Create GitHub App token (IAT)
        id: app-token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ secrets.TED_APP_ID }}
          private-key: ${{ secrets.TED_APP_PRIVATE_KEY }}

      - name: Configure Codex MCP (remote GitHub MCP)
        run: |
          set -euo pipefail
          mkdir -p ~/.codex
          cat > ~/.codex/config.toml <<'TOML'
          [mcp_servers.github]
          url = "https://api.githubcopilot.com/mcp/"
          bearer_token_env_var = "GITHUB_MCP_BEARER"
          http_headers = { "X-MCP-Toolsets" = "context,issues,repos" }
          startup_timeout_sec = 20
          tool_timeout_sec = 60
          enabled = true
          TOML

      - name: Draft via Python (prepare, run Codex, summarize)
        id: readout
        env:
          CODEX_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          GITHUB_MCP_BEARER: ${{ steps.app-token.outputs.token }}
        run: |
          set -euo pipefail
          python3 .github/scripts/ted_draft.py

      - name: Upload draft artifact (private)
        uses: actions/upload-artifact@v4
        with:
          name: ted-draft
          path: .ted/draft.json

  post:
    needs: draft
    runs-on: ubuntu-latest

    if: needs.draft.outputs.should_post == 'true' || needs.draft.outputs.escalate == 'true'

    # Approval gate — configure in repo Settings → Environments → "ted-approval"
    environment: ted-approval

    steps:
      - uses: actions/checkout@v4

      - name: Download draft artifact
        uses: actions/download-artifact@v4
        with:
          name: ted-draft
          path: .ted

      - name: Capture target repo + issue
        run: |
          set -euo pipefail
          echo "${{ github.repository }}" > .ted/target_repo.txt
          echo "${{ github.event.issue.number }}" > .ted/target_issue.txt
          echo "Target repo: $(cat .ted/target_repo.txt)"
          echo "Target issue: $(cat .ted/target_issue.txt)"

      # Fresh IAT here (the action revokes tokens after the job by default)
      - name: Create GitHub App token (IAT)
        id: app-token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ secrets.TED_APP_ID }}
          private-key: ${{ secrets.TED_APP_PRIVATE_KEY }}

      - name: Post approved draft via GitHub API (IAT only)
        env:
          GITHUB_TOKEN: ${{ steps.app-token.outputs.token }}
        run: |
          set -euo pipefail
          python3 .github/scripts/ted_post.py
